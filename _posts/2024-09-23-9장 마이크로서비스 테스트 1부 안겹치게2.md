---
title: 9장 마이크로서비스 테스트 1부 안겹치게2
date: 2024-09-23 07:00:00 +0900
categories: [Software Development, Software Design]
tags: [MSA, 마이크로서비스 패턴 크리스 리처드슨] # TAG names should always be lowercase
---

# 목차

```
9장 마이크로서비스 테스트 1부
9.1 마이크로서비스 아키텍처 테스트 전략
__9.1.1 테스트 개요
__9.1.2 마이크로서비스 테스트
__9.1.3 배포 파이프라인
9.2 서비스 단위 테스트 작성
__9.2.1 단위 테스트 작성: 엔터티
__9.2.2 단위 테스트 작성: 밸류 객체
__9.2.3 단위 테스트 작성: 사가
__9.2.4 단위 테스트 작성: 도메인 서비스
__9.2.5 단위 테스트 작성: 컨트롤러
__9.2.6 단위 테스트 작성: 이벤트/메시지 핸들러
9.3 마치며
```

# 정리 전략?

- 전부 정리는 NO
- 핵심중에서 꼭 적고 가야겠다 싶은 것만!
- 나의 생각을 섞어서 적을것..!
- 떠오르는 것 먼저 간단하게..!

# 내용

9장 마이크로서비스 테스트 1부
9.1 마이크로서비스 아키텍처 테스트 전략
### __9.1.1 테스트 개요
#### 테스트 종류.
- 단위 테스트 : 서비스의 작은 부분을 테스트(클래스)
- 통합 테스트 : 어플리케이션 서비스의 인프라 및 외부서비스와의 연동 테스트
- 컴포넌트 테스트 : 개별서비스들에 대한 인수테스트(Acceptance Test)
- 종단 간 테스트(end-to-end) : 전체 어플리케이션에 대한 인수테스트
#### 테스트 사분면
![](assets/img/posts/2024-09-23-12-50-20.png)
#### 테스트 피라미드
* 단위테스트는 많이, 종단간 테스트는 적게.
### __9.1.2 마이크로서비스 테스트
#### 컨슈머 주도 계약 테스트
* API gw 에서 주문서비스 GET /orders/{orderId} 를 테스트 한다고 가정시 관계
  * 컨슈머 : API gw
  * 프로바이더 : 주문서비스
* 컨슈머는 프로바이더가 다음과 같은 일을 하는 endpoint 가 구현되었는지 확인한다.
  * HTTP method, uri, header, body, 등.
* 컨슈머 계약 테스트는 비즈니스 로직을 빠짐없이 체크하는 테스트가 아니다.
* mock controller 테스트 이다.

#### 서비스 테스트: 스프링 클라우드 컨트랙트
![](assets/img/posts/2024-09-23-12-58-21.png)
* 계약 작성. 작성된 계약은 pr 로 주문서비스에 전달
* 주문 서비스 팀은 contract test로 주문 서비스를 테스트. 테스트코드는 자동생성된다.
* 주문 서비스 팀은 주문 서비스를 테스트한 계약을 메이븐 저장소로 jar 발행
* 주문서비스 팀이 발행한 jar 를 내려받아, API 게이트웨이 테스트를 작성한다.
* 컨슈머 쪽에서 효용성

모키토로 스텁해서 주문 서비스 동작을 시뮬레이션 하는 용도로 사용
API 가 실제로 발행이 안되어도 개발이 가능
프로바이더 쪽에서 효용성

code generated 된 테스트 클래스 이용하여, 실제로 프로바이더가 계약에 맞게 응답을 반환하는지 테스트 가능
org.springframework.cloud.contract.spec.Contract.make {
    request {
        method 'GET'
        url '/orders/1223232'
    }
    response {
        status 200
        headers {
            header('Content-Type': 'application/json;charset=UTF-8')
        }
        body("{ ... }")
    }
}
API 게이트웨이가 주문 서비스를 어떻게 호출하는지 기술한 계약

#### 컨슈머 계약 테스트: 메시징 API
* 스프링 클라우드 컨트랙트는 메시징 기반도 테스트 가능.

* 프로바이더쪽
  * 이벤트 발생시키도록 만들고 그것이 계약과 일치하는지 확인.
* 컨슈머쪽
  * 이 이벤트를 컨슈머가 처리할수있는지 확인. (스텁 구독기)


### __9.1.3 배포 파이프라인
* 배포 파이프라인은 Jenkins같은 CI 툴로 배포 파이프라인을 구성한다.
* 배포 프로세스는 조직마다 상이할 수 있지만, 본 책에서는 아래와 같이 구성했다.
* 커밋 테스트 -> 통합 테스트 -> 컴포넌트 테스트 -> 배포
## 9.2 서비스 단위 테스트 작성
### __9.2.1 단위 테스트 작성: 엔터티
### __9.2.2 단위 테스트 작성: 밸류 객체
### __9.2.3 단위 테스트 작성: 사가
### __9.2.4 단위 테스트 작성: 도메인 서비스
### __9.2.5 단위 테스트 작성: 컨트롤러
### __9.2.6 단위 테스트 작성: 이벤트/메시지 핸들러
9.3 마치며

# 참고자료

-
